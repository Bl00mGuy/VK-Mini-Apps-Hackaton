{"version":3,"file":"RouterProvider.js","sourceRoot":"","sources":["../../src/components/RouterProvider.tsx"],"names":[],"mappings":";AAAA,OAAO,EAA2B,SAAS,EAAE,eAAe,EAAE,OAAO,EAAE,QAAQ,EAAE,MAAM,OAAO,CAAC;AAC/F,OAAO,EAAE,MAAM,EAAU,MAAM,mBAAmB,CAAC;AACnD,OAAO,MAAM,MAAM,sBAAsB,CAAC;AAC1C,OAAO,EAAE,oBAAoB,EAAE,qBAAqB,EAAE,aAAa,EAAE,MAAM,UAAU,CAAC;AACtF,OAAO,EAAE,aAAa,EAAE,YAAY,EAAE,aAAa,EAAE,MAAM,aAAa,CAAC;AACzE,OAAO,EAAE,eAAe,EAAE,WAAW,EAAE,kBAAkB,EAAE,kBAAkB,EAAE,MAAM,UAAU,CAAC;AAChG,OAAO,EACL,qBAAqB,EACrB,sBAAsB,EACtB,mBAAmB,EAEnB,WAAW,GACZ,MAAM,aAAa,CAAC;AACrB,OAAO,EAAE,uBAAuB,EAAE,MAAM,kCAAkC,CAAC;AAC3E,OAAO,EAAE,eAAe,EAAE,MAAM,mBAAmB,CAAC;AAcpD,MAAM,UAAU,cAAc,CAAC,EAC7B,MAAM,EACN,QAAQ,EACR,QAAQ,EACR,SAAS,EACT,oBAAoB,EACpB,QAAQ,GAAG,GAAG,EACd,SAAS,GAAG,IAAI,EAChB,SAAS,GAAG,IAAI,GACI;IACpB,MAAM,CAAC,MAAM,EAAE,SAAS,CAAC,GAAG,QAAQ,CAAqB,IAAI,CAAC,CAAC;IAC/D,MAAM,CAAC,WAAW,CAAC,GAAG,QAAQ,CAAc,IAAI,WAAW,EAAE,CAAC,CAAC;IAC/D,MAAM,CAAC,aAAa,EAAE,gBAAgB,CAAC,GAAG,QAAQ,CAAW,EAAE,CAAC,CAAC;IACjE,MAAM,aAAa,GAAG,MAAM,CAAC,KAAK,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,qBAAqB,CAAC,CAAC;IAE3E,MAAM,iBAAiB,GAAG,OAAO,CAAC,GAAG,EAAE;QACrC,MAAM,cAAc,GAAmB,IAAI,qBAAqB,CAC9D,MAAM,EACN,WAAW,EACX,SAAS,CACV,CAAC;QACF,OAAO,EAAE,MAAM,EAAE,cAAc,EAAE,WAAW,EAAE,CAAC;IACjD,CAAC,EAAE,CAAC,MAAM,EAAE,WAAW,EAAE,SAAS,CAAC,CAAC,CAAC;IAErC,MAAM,YAAY,GAAG,OAAO,CAC1B,GAAG,EAAE,CAAC,eAAe,CAAC,MAAM,CAAC,KAAK,EAAE,aAAa,CAAC,EAClD,CAAC,MAAM,CAAC,KAAK,EAAE,aAAa,CAAC,CAC9B,CAAC;IAEF,MAAM,iBAAiB,GAAG,OAAO,CAAC,GAAG,EAAE;QACrC,OAAO,EAAE,MAAM,EAAE,aAAa,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;IACnD,CAAC,EAAE,CAAC,aAAa,EAAE,MAAM,CAAC,CAAC,CAAC;IAE5B,uBAAuB,CAAC,MAAM,EAAE,WAAW,EAAE,iBAAiB,CAAC,cAAc,CAAC,CAAC;IAC/E,SAAS,CAAC,GAAG,EAAE;QACb,0EAA0E;QAC1E,OAAO,CAAC,iBAAiB,GAAG,QAAQ,CAAC;QAErC,mBAAmB,CAAC,iBAAiB,EAAE,CAAC;QACxC,WAAW,CAAC,YAAY,EAAE,CAAC;QAC3B,WAAW,CAAC,gBAAgB,CAAC,EAAE,GAAG,MAAM,CAAC,KAAK,EAAE,aAAa,EAAE,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC;QAC9E,gBAAgB,CAAC,WAAW,CAAC,aAAa,CAAC,CAAC;QAE5C,MAAM,CAAC,SAAS,CAAC,CAAC,KAAK,EAAE,EAAE;YACzB,WAAW,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;YACpC,gBAAgB,CAAC,WAAW,CAAC,aAAa,CAAC,CAAC;YAC5C,mBAAmB,CAAC,MAAM,EAAE,CAAC;QAC/B,CAAC,CAAC,CAAC;QAEH,IAAI,SAAS,EAAE;YACb,MAAM,CAAC,SAAS,CAAC,CAAC,KAAK,EAAE,EAAE;gBACzB,IAAI,KAAK,CAAC,MAAM,CAAC,IAAI,KAAK,wBAAwB,EAAE;oBAClD,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;iBAChE;YACH,CAAC,CAAC,CAAC;YAEH,MAAM,CAAC,SAAS,CAAC,CAAC,KAAK,EAAE,EAAE;gBACzB,MAAM,IAAI,GAAG,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;gBAC/C,MAAM,eAAe,GAAG,kBAAkB,EAAE,CAAC;gBAC7C,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,eAAe,EAAE,EAAE,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;gBACrE,MAAM,CAAC,IAAI,CAAC,qBAAqB,EAAE,EAAE,QAAQ,EAAE,aAAa,EAAE,IAAI,EAAE,CAAC,CAAC;YACxE,CAAC,CAAC,CAAC;SACJ;QAED,MAAM,YAAY,GAAG,kBAAkB,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;QACtE,MAAM,aAAa,GAAG,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC,CAAC;QACtE,IAAI,SAAS,IAAI,aAAa,EAAE;YAC9B,WAAW,CAAC,SAAS,EAAE,iBAAiB,CAAC,cAAc,EAAE,YAAY,CAAC,CAAC;SACxE;IACH,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC;IAEb,eAAe,CAAC,GAAG,EAAE;QACnB,sBAAsB,CAAC,8BAA8B,CAAC;YACpD,QAAQ;YACR,SAAS;SACV,CAAC,CAAC;IACL,CAAC,EAAE,CAAC,QAAQ,EAAE,SAAS,CAAC,CAAC,CAAC;IAE1B,MAAM,aAAa,GAAG,OAAO,CAC3B,CAAC,YAAY,CAAC,KAAK;QACjB,CAAC,YAAY,CAAC,KAAK,CAAC,MAAM;YACxB,YAAY,CAAC,KAAK,CAAC,MAAM,CAAC,YAAY,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE,CAAC;YACtD,YAAY,CAAC,KAAK,CAAC,MAAM,CAAC,YAAY,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,MAAM,KAAK,GAAG,CAAC,CAC3E,CAAC;IAEF,IAAI,oBAAoB,IAAI,CAAC,aAAa,IAAI,YAAY,CAAC,KAAK,EAAE,KAAK,CAAC,IAAI,KAAK,aAAa,CAAC,EAAE;QAC/F,IAAI,MAAM,CAAC,KAAK,CAAC,QAAQ,CAAC,QAAQ,KAAK,oBAAoB,EAAE;YAC3D,OAAO,CAAC,IAAI,CAAC,gCAAgC,CAAC,CAAC;SAChD;;YAAM,iBAAiB,CAAC,cAAc,CAAC,OAAO,CAAC,oBAAoB,CAAC,CAAC;KACvE;IAED,OAAO,CACL,KAAC,aAAa,CAAC,QAAQ,IAAC,KAAK,EAAE,iBAAiB,YAC9C,MAAC,aAAa,CAAC,QAAQ,IAAC,KAAK,EAAE,iBAAiB,aAC7C,aAAa;oBACZ,CAAC,QAAQ,IAAI,KAAC,eAAe,IAAC,cAAc,EAAE,iBAAiB,CAAC,cAAc,GAAI,CAAC,EACpF,CAAC,aAAa,IAAI,KAAC,YAAY,CAAC,QAAQ,IAAC,KAAK,EAAE,YAAY,EAAE,QAAQ,EAAE,QAAQ,GAAI,IAC9D,GACF,CAC1B,CAAC;AACJ,CAAC","sourcesContent":["import { ReactElement, ReactNode, useEffect, useLayoutEffect, useMemo, useState } from 'react';\nimport { Action, Router } from '@remix-run/router';\nimport bridge from '@vkontakte/vk-bridge';\nimport { SEARCH_PARAM_INFLATE, STATE_KEY_SHOW_POPOUT, UNIVERSAL_URL } from '../const';\nimport { PopoutContext, RouteContext, RouterContext } from '../contexts';\nimport { getRouteContext, fillHistory, createSearchParams, getHrefWithoutHash } from '../utils';\nimport {\n  DefaultRouteNavigator,\n  ContextThrottleService,\n  TransactionExecutor,\n  RouteNavigator,\n  ViewHistory,\n} from '../services';\nimport { useBlockForwardToModals } from '../hooks/useBlockForwardToModals';\nimport { DefaultNotFound } from './DefaultNotFound';\nimport { RouteLeaf } from '../type';\n\nexport interface RouterProviderProps {\n  router: Router;\n  children: ReactNode;\n  interval?: number;\n  useBridge?: boolean;\n  throttled?: boolean;\n  hierarchy?: RouteLeaf[];\n  notFound?: ReactNode;\n  notFoundRedirectPath?: string;\n}\n\nexport function RouterProvider({\n  router,\n  children,\n  notFound,\n  hierarchy,\n  notFoundRedirectPath,\n  interval = 400,\n  useBridge = true,\n  throttled = true,\n}: RouterProviderProps): ReactElement {\n  const [popout, setPopout] = useState<JSX.Element | null>(null);\n  const [viewHistory] = useState<ViewHistory>(new ViewHistory());\n  const [panelsHistory, setPanelsHistory] = useState<string[]>([]);\n  const isPopoutShown = router.state.location.state?.[STATE_KEY_SHOW_POPOUT];\n\n  const dataRouterContext = useMemo(() => {\n    const routeNavigator: RouteNavigator = new DefaultRouteNavigator(\n      router,\n      viewHistory,\n      setPopout,\n    );\n    return { router, routeNavigator, viewHistory };\n  }, [router, viewHistory, setPopout]);\n\n  const routeContext = useMemo(\n    () => getRouteContext(router.state, panelsHistory),\n    [router.state, panelsHistory],\n  );\n\n  const dataPopoutContext = useMemo(() => {\n    return { popout: isPopoutShown ? popout : null };\n  }, [isPopoutShown, popout]);\n\n  useBlockForwardToModals(router, viewHistory, dataRouterContext.routeNavigator);\n  useEffect(() => {\n    // Отключаем браузерное восстановление скролла, используем решения от VKUI\n    history.scrollRestoration = 'manual';\n\n    TransactionExecutor.resetTransactions();\n    viewHistory.resetHistory();\n    viewHistory.updateNavigation({ ...router.state, historyAction: Action.Push });\n    setPanelsHistory(viewHistory.panelsHistory);\n\n    router.subscribe((state) => {\n      viewHistory.updateNavigation(state);\n      setPanelsHistory(viewHistory.panelsHistory);\n      TransactionExecutor.doNext();\n    });\n\n    if (useBridge) {\n      bridge.subscribe((event) => {\n        if (event.detail.type === 'VKWebAppChangeFragment') {\n          router.navigate(event.detail.data.location, { replace: true });\n        }\n      });\n\n      router.subscribe((state) => {\n        const href = router.createHref(state.location);\n        const hrefWithoutHash = getHrefWithoutHash();\n        const location = href.replace(hrefWithoutHash, '').replace(/^#/, '');\n        bridge.send('VKWebAppSetLocation', { location, replace_state: true });\n      });\n    }\n\n    const searchParams = createSearchParams(router.state.location.search);\n    const enableFilling = Boolean(searchParams.get(SEARCH_PARAM_INFLATE));\n    if (hierarchy && enableFilling) {\n      fillHistory(hierarchy, dataRouterContext.routeNavigator, routeContext);\n    }\n  }, [router]);\n\n  useLayoutEffect(() => {\n    ContextThrottleService.updateThrottledServiceSettings({\n      interval,\n      throttled,\n    });\n  }, [interval, throttled]);\n\n  const routeNotFound = Boolean(\n    !routeContext.match ||\n      (routeContext.state.errors &&\n        routeContext.state.errors[routeContext.match.route.id] &&\n        routeContext.state.errors[routeContext.match.route.id].status === 404),\n  );\n\n  if (notFoundRedirectPath && (routeNotFound || routeContext.match?.route.path === UNIVERSAL_URL)) {\n    if (router.state.location.pathname === notFoundRedirectPath) {\n      console.warn('Incorrect notFoundRedirectPath');\n    } else dataRouterContext.routeNavigator.replace(notFoundRedirectPath);\n  }\n\n  return (\n    <RouterContext.Provider value={dataRouterContext}>\n      <PopoutContext.Provider value={dataPopoutContext}>\n        {routeNotFound &&\n          (notFound || <DefaultNotFound routeNavigator={dataRouterContext.routeNavigator} />)}\n        {!routeNotFound && <RouteContext.Provider value={routeContext} children={children} />}\n      </PopoutContext.Provider>\n    </RouterContext.Provider>\n  );\n}\n"]}