{"version":3,"sources":["../../src/hooks/useEnsuredControl.ts"],"sourcesContent":["import * as React from 'react';\nimport { isFunction } from '@vkontakte/vkjs';\nimport { useIsomorphicLayoutEffect } from '../lib/useIsomorphicLayoutEffect';\nimport { warnOnce } from '../lib/warnOnce';\n\nexport interface UseEnsuredControlProps<V, E extends React.ChangeEvent<any>> {\n  value?: V;\n  defaultValue: V;\n  disabled?: boolean | undefined;\n  onChange?: (this: void, e: E) => any;\n}\n\nexport function useEnsuredControl<V, E extends React.ChangeEvent<any>>({\n  onChange: onChangeProp,\n  disabled,\n  ...props\n}: UseEnsuredControlProps<V, E>): [V, (e: E) => any] {\n  const [value, onChangeValue] = useCustomEnsuredControl(props);\n\n  const onChange = React.useCallback(\n    (e: E) => {\n      if (disabled) {\n        return;\n      }\n\n      onChangeValue(e.target.value);\n      onChangeProp && onChangeProp(e);\n    },\n    [onChangeValue, onChangeProp, disabled],\n  );\n\n  return [value, onChange];\n}\n\nexport interface UseCustomEnsuredControlProps<V> {\n  value?: V;\n  defaultValue: V;\n  disabled?: boolean | undefined;\n  onChange?: (this: void, v: V) => any;\n}\n\nconst warn = warnOnce('useCustomEnsuredControl');\n\nexport function useCustomEnsuredControl<V = any>({\n  value,\n  defaultValue,\n  disabled,\n  onChange: onChangeProp,\n}: UseCustomEnsuredControlProps<V>): [V, React.Dispatch<React.SetStateAction<V>>] {\n  const isControlled = value !== undefined;\n  const [localValue, setLocalValue] = React.useState(defaultValue);\n\n  const preservedControlledValueRef = React.useRef<V | undefined>();\n  useIsomorphicLayoutEffect(() => {\n    preservedControlledValueRef.current = value;\n  });\n\n  /*\n   * Для ситуации, когда nextValue это пользовательская функция,\n   * и в качестве аргумента мы должны передать prevValue.\n   * Обычно в качестве prevValue используется preservedControlledValueRef, но оно может быть undefined, если\n   * некотролируемое value вдруг стало контролируемым\n   * (value = undefined ---> value = true)\n   * Если в момент вызова onChange preservedControlledValueRef ещё не был\n   * обновлён в useEffect, то мы не можем использовать preservedControlledValueRef как prevValue\n   * В качестве запасного варианта мы храним текущее значение value в currentFallbackValueRef, чтобы\n   * использовать его вместо preservedControlledValueRef.\n   */\n  const currentFallbackValueRef = React.useRef<V | undefined>(value);\n  currentFallbackValueRef.current = value;\n\n  const onChange = React.useCallback(\n    (nextValue: React.SetStateAction<V>) => {\n      if (disabled) {\n        return;\n      }\n\n      if (isFunction(nextValue)) {\n        if (!isControlled) {\n          setLocalValue((prevValue) => {\n            const resolvedValue = nextValue(prevValue);\n            if (onChangeProp) {\n              onChangeProp(resolvedValue);\n            }\n            return resolvedValue;\n          });\n        } else if (onChangeProp) {\n          if (process.env.NODE_ENV === 'development') {\n            if (preservedControlledValueRef.current === undefined) {\n              warn(\n                `Похоже, что при вызове onChange с аргументом nextValue в виде коллбэка, состояние компонента было переведено из неконтролируемого (\"undefined\") в контролируемое. Пожалуйста, старайтесь сохранять либо неконтролируемое состояние, либо контролируемое на всём промежутке жизненного цикла компонента, чтобы получать предсказуемое значение prevValue в коллбэке nextValue((prevValue: V) => V)`,\n                'error',\n              );\n            }\n          }\n\n          const prevValue =\n            preservedControlledValueRef.current === undefined\n              ? currentFallbackValueRef.current\n              : preservedControlledValueRef.current;\n          // В теории prevValue не может быть undefined,\n          // но лучше не вызывать nextValue с таким значением\n          if (prevValue !== undefined) {\n            const resolvedValue = nextValue(prevValue);\n            onChangeProp(resolvedValue);\n          }\n        }\n      } else {\n        if (onChangeProp) {\n          onChangeProp(nextValue);\n        }\n        if (!isControlled) {\n          setLocalValue(nextValue);\n        }\n      }\n    },\n    [disabled, isControlled, onChangeProp],\n  );\n\n  return [isControlled ? value : localValue, onChange];\n}\n"],"names":["React","isFunction","useIsomorphicLayoutEffect","warnOnce","useEnsuredControl","onChange","onChangeProp","disabled","props","value","onChangeValue","useCustomEnsuredControl","useCallback","e","target","warn","defaultValue","isControlled","undefined","localValue","setLocalValue","useState","preservedControlledValueRef","useRef","current","currentFallbackValueRef","nextValue","prevValue","resolvedValue","process","env","NODE_ENV"],"mappings":";AAAA,YAAYA,WAAW,QAAQ;AAC/B,SAASC,UAAU,QAAQ,kBAAkB;AAC7C,SAASC,yBAAyB,QAAQ,mCAAmC;AAC7E,SAASC,QAAQ,QAAQ,kBAAkB;AAS3C,OAAO,SAASC,kBAAuD;QAAA,EACrEC,UAAUC,YAAY,EACtBC,QAAQ,EAEqB,GAJwC,QAGlEC,mCAHkE;QACrEH;QACAE;;IAGA,MAAM,CAACE,OAAOC,cAAc,GAAGC,wBAAwBH;IAEvD,MAAMH,WAAWL,MAAMY,WAAW,CAChC,CAACC;QACC,IAAIN,UAAU;YACZ;QACF;QAEAG,cAAcG,EAAEC,MAAM,CAACL,KAAK;QAC5BH,gBAAgBA,aAAaO;IAC/B,GACA;QAACH;QAAeJ;QAAcC;KAAS;IAGzC,OAAO;QAACE;QAAOJ;KAAS;AAC1B;AASA,MAAMU,OAAOZ,SAAS;AAEtB,OAAO,SAASQ,wBAAiC,EAC/CF,KAAK,EACLO,YAAY,EACZT,QAAQ,EACRF,UAAUC,YAAY,EACU;IAChC,MAAMW,eAAeR,UAAUS;IAC/B,MAAM,CAACC,YAAYC,cAAc,GAAGpB,MAAMqB,QAAQ,CAACL;IAEnD,MAAMM,8BAA8BtB,MAAMuB,MAAM;IAChDrB,0BAA0B;QACxBoB,4BAA4BE,OAAO,GAAGf;IACxC;IAEA;;;;;;;;;;GAUC,GACD,MAAMgB,0BAA0BzB,MAAMuB,MAAM,CAAgBd;IAC5DgB,wBAAwBD,OAAO,GAAGf;IAElC,MAAMJ,WAAWL,MAAMY,WAAW,CAChC,CAACc;QACC,IAAInB,UAAU;YACZ;QACF;QAEA,IAAIN,WAAWyB,YAAY;YACzB,IAAI,CAACT,cAAc;gBACjBG,cAAc,CAACO;oBACb,MAAMC,gBAAgBF,UAAUC;oBAChC,IAAIrB,cAAc;wBAChBA,aAAasB;oBACf;oBACA,OAAOA;gBACT;YACF,OAAO,IAAItB,cAAc;gBACvB,IAAIuB,QAAQC,GAAG,CAACC,QAAQ,KAAK,eAAe;oBAC1C,IAAIT,4BAA4BE,OAAO,KAAKN,WAAW;wBACrDH,KACE,CAAC,iYAAiY,CAAC,EACnY;oBAEJ;gBACF;gBAEA,MAAMY,YACJL,4BAA4BE,OAAO,KAAKN,YACpCO,wBAAwBD,OAAO,GAC/BF,4BAA4BE,OAAO;gBACzC,8CAA8C;gBAC9C,mDAAmD;gBACnD,IAAIG,cAAcT,WAAW;oBAC3B,MAAMU,gBAAgBF,UAAUC;oBAChCrB,aAAasB;gBACf;YACF;QACF,OAAO;YACL,IAAItB,cAAc;gBAChBA,aAAaoB;YACf;YACA,IAAI,CAACT,cAAc;gBACjBG,cAAcM;YAChB;QACF;IACF,GACA;QAACnB;QAAUU;QAAcX;KAAa;IAGxC,OAAO;QAACW,eAAeR,QAAQU;QAAYd;KAAS;AACtD"}