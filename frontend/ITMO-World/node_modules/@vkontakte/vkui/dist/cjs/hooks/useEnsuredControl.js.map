{"version":3,"sources":["../../../src/hooks/useEnsuredControl.ts"],"sourcesContent":["import * as React from 'react';\nimport { isFunction } from '@vkontakte/vkjs';\nimport { useIsomorphicLayoutEffect } from '../lib/useIsomorphicLayoutEffect';\nimport { warnOnce } from '../lib/warnOnce';\n\nexport interface UseEnsuredControlProps<V, E extends React.ChangeEvent<any>> {\n  value?: V;\n  defaultValue: V;\n  disabled?: boolean | undefined;\n  onChange?: (this: void, e: E) => any;\n}\n\nexport function useEnsuredControl<V, E extends React.ChangeEvent<any>>({\n  onChange: onChangeProp,\n  disabled,\n  ...props\n}: UseEnsuredControlProps<V, E>): [V, (e: E) => any] {\n  const [value, onChangeValue] = useCustomEnsuredControl(props);\n\n  const onChange = React.useCallback(\n    (e: E) => {\n      if (disabled) {\n        return;\n      }\n\n      onChangeValue(e.target.value);\n      onChangeProp && onChangeProp(e);\n    },\n    [onChangeValue, onChangeProp, disabled],\n  );\n\n  return [value, onChange];\n}\n\nexport interface UseCustomEnsuredControlProps<V> {\n  value?: V;\n  defaultValue: V;\n  disabled?: boolean | undefined;\n  onChange?: (this: void, v: V) => any;\n}\n\nconst warn = warnOnce('useCustomEnsuredControl');\n\nexport function useCustomEnsuredControl<V = any>({\n  value,\n  defaultValue,\n  disabled,\n  onChange: onChangeProp,\n}: UseCustomEnsuredControlProps<V>): [V, React.Dispatch<React.SetStateAction<V>>] {\n  const isControlled = value !== undefined;\n  const [localValue, setLocalValue] = React.useState(defaultValue);\n\n  const preservedControlledValueRef = React.useRef<V | undefined>();\n  useIsomorphicLayoutEffect(() => {\n    preservedControlledValueRef.current = value;\n  });\n\n  /*\n   * Для ситуации, когда nextValue это пользовательская функция,\n   * и в качестве аргумента мы должны передать prevValue.\n   * Обычно в качестве prevValue используется preservedControlledValueRef, но оно может быть undefined, если\n   * некотролируемое value вдруг стало контролируемым\n   * (value = undefined ---> value = true)\n   * Если в момент вызова onChange preservedControlledValueRef ещё не был\n   * обновлён в useEffect, то мы не можем использовать preservedControlledValueRef как prevValue\n   * В качестве запасного варианта мы храним текущее значение value в currentFallbackValueRef, чтобы\n   * использовать его вместо preservedControlledValueRef.\n   */\n  const currentFallbackValueRef = React.useRef<V | undefined>(value);\n  currentFallbackValueRef.current = value;\n\n  const onChange = React.useCallback(\n    (nextValue: React.SetStateAction<V>) => {\n      if (disabled) {\n        return;\n      }\n\n      if (isFunction(nextValue)) {\n        if (!isControlled) {\n          setLocalValue((prevValue) => {\n            const resolvedValue = nextValue(prevValue);\n            if (onChangeProp) {\n              onChangeProp(resolvedValue);\n            }\n            return resolvedValue;\n          });\n        } else if (onChangeProp) {\n          if (process.env.NODE_ENV === 'development') {\n            if (preservedControlledValueRef.current === undefined) {\n              warn(\n                `Похоже, что при вызове onChange с аргументом nextValue в виде коллбэка, состояние компонента было переведено из неконтролируемого (\"undefined\") в контролируемое. Пожалуйста, старайтесь сохранять либо неконтролируемое состояние, либо контролируемое на всём промежутке жизненного цикла компонента, чтобы получать предсказуемое значение prevValue в коллбэке nextValue((prevValue: V) => V)`,\n                'error',\n              );\n            }\n          }\n\n          const prevValue =\n            preservedControlledValueRef.current === undefined\n              ? currentFallbackValueRef.current\n              : preservedControlledValueRef.current;\n          // В теории prevValue не может быть undefined,\n          // но лучше не вызывать nextValue с таким значением\n          if (prevValue !== undefined) {\n            const resolvedValue = nextValue(prevValue);\n            onChangeProp(resolvedValue);\n          }\n        }\n      } else {\n        if (onChangeProp) {\n          onChangeProp(nextValue);\n        }\n        if (!isControlled) {\n          setLocalValue(nextValue);\n        }\n      }\n    },\n    [disabled, isControlled, onChangeProp],\n  );\n\n  return [isControlled ? value : localValue, onChange];\n}\n"],"names":["useCustomEnsuredControl","useEnsuredControl","onChange","onChangeProp","disabled","props","value","onChangeValue","React","useCallback","e","target","warn","warnOnce","defaultValue","isControlled","undefined","localValue","setLocalValue","useState","preservedControlledValueRef","useRef","useIsomorphicLayoutEffect","current","currentFallbackValueRef","nextValue","isFunction","prevValue","resolvedValue","process","env","NODE_ENV"],"mappings":";;;;;;;;;;;IA2CgBA,uBAAuB;eAAvBA;;IA/BAC,iBAAiB;eAAjBA;;;;;iEAZO;sBACI;2CACe;0BACjB;AASlB,SAASA,kBAAuD;QAAA,EACrEC,UAAUC,YAAY,EACtBC,QAAQ,EAEqB,GAJwC,QAGlEC,qCAHkE;QACrEH;QACAE;;IAGA,MAAM,CAACE,OAAOC,cAAc,GAAGP,wBAAwBK;IAEvD,MAAMH,WAAWM,OAAMC,WAAW,CAChC,CAACC;QACC,IAAIN,UAAU;YACZ;QACF;QAEAG,cAAcG,EAAEC,MAAM,CAACL,KAAK;QAC5BH,gBAAgBA,aAAaO;IAC/B,GACA;QAACH;QAAeJ;QAAcC;KAAS;IAGzC,OAAO;QAACE;QAAOJ;KAAS;AAC1B;AASA,MAAMU,OAAOC,IAAAA,kBAAQ,EAAC;AAEf,SAASb,wBAAiC,EAC/CM,KAAK,EACLQ,YAAY,EACZV,QAAQ,EACRF,UAAUC,YAAY,EACU;IAChC,MAAMY,eAAeT,UAAUU;IAC/B,MAAM,CAACC,YAAYC,cAAc,GAAGV,OAAMW,QAAQ,CAACL;IAEnD,MAAMM,8BAA8BZ,OAAMa,MAAM;IAChDC,IAAAA,oDAAyB,EAAC;QACxBF,4BAA4BG,OAAO,GAAGjB;IACxC;IAEA;;;;;;;;;;GAUC,GACD,MAAMkB,0BAA0BhB,OAAMa,MAAM,CAAgBf;IAC5DkB,wBAAwBD,OAAO,GAAGjB;IAElC,MAAMJ,WAAWM,OAAMC,WAAW,CAChC,CAACgB;QACC,IAAIrB,UAAU;YACZ;QACF;QAEA,IAAIsB,IAAAA,gBAAU,EAACD,YAAY;YACzB,IAAI,CAACV,cAAc;gBACjBG,cAAc,CAACS;oBACb,MAAMC,gBAAgBH,UAAUE;oBAChC,IAAIxB,cAAc;wBAChBA,aAAayB;oBACf;oBACA,OAAOA;gBACT;YACF,OAAO,IAAIzB,cAAc;gBACvB,IAAI0B,QAAQC,GAAG,CAACC,QAAQ,KAAK,eAAe;oBAC1C,IAAIX,4BAA4BG,OAAO,KAAKP,WAAW;wBACrDJ,KACE,CAAC,iYAAiY,CAAC,EACnY;oBAEJ;gBACF;gBAEA,MAAMe,YACJP,4BAA4BG,OAAO,KAAKP,YACpCQ,wBAAwBD,OAAO,GAC/BH,4BAA4BG,OAAO;gBACzC,8CAA8C;gBAC9C,mDAAmD;gBACnD,IAAII,cAAcX,WAAW;oBAC3B,MAAMY,gBAAgBH,UAAUE;oBAChCxB,aAAayB;gBACf;YACF;QACF,OAAO;YACL,IAAIzB,cAAc;gBAChBA,aAAasB;YACf;YACA,IAAI,CAACV,cAAc;gBACjBG,cAAcO;YAChB;QACF;IACF,GACA;QAACrB;QAAUW;QAAcZ;KAAa;IAGxC,OAAO;QAACY,eAAeT,QAAQW;QAAYf;KAAS;AACtD"}